# IP封禁技能 - LLM集成完成

## 更新内容

已成功实现LLM意图检测和参数提取功能，现在系统可以**自动识别并处理**IP封禁相关的自然语言输入！

## 现在可以使用的功能

### 1. 自动意图识别

系统现在可以自动识别以下意图：
- ✅ **添加资产** - "添加一个服务器" / "注册新资产"
- ✅ **IP封禁** - "查询IP是否被封禁" / "封禁IP地址"
- ✅ **普通聊天** - 其他对话

### 2. 支持的自然语言输入

#### 场景1：查询IP封禁状态
```
查询155.158.127.248是否被封禁
```
系统会：
1. 自动识别这是IP封禁查询
2. 提取IP地址：155.158.127.248
3. 调用API查询封禁状态
4. 显示结果（已封禁/未封禁）

---

#### 场景2：检查并封禁（主要功能）
```
请帮我查询100.200.1.200这个IP地址是否已经被封禁，没有的话帮我调用AF1这个设备进行封禁
```

系统会：
1. 自动识别这是"检查并封禁"操作
2. 提取IP地址：100.200.1.200
3. 提取设备名称：AF1
4. 检查IP是否已封禁
5. 如果未封禁，显示确认对话框
6. 用户确认后执行封禁

---

#### 场景3：直接封禁
```
使用AF1封禁192.168.1.50
```

系统会：
1. 识别为IP封禁操作
2. 提取IP和设备信息
3. 显示确认对话框
4. 执行封禁

---

#### 场景4：临时封禁
```
封禁10.0.0.100，封禁7天，使用设备AF2
```

系统会：
1. 识别为临时封禁操作
2. 提取IP、设备、时长参数
3. 显示确认对话框
4. 执行7天临时封禁

---

## 实现的技术细节

### 1. LLM意图检测（`_detect_intent`）

```python
intent_prompt = f"""你是一个意图识别助手。判断用户消息的意图类型。

用户消息: {user_message}

分析用户是否想要：
1. 添加资产 - 添加新资产、创建新服务器、注册新设备
2. IP封禁 - 查询IP封禁状态、封禁IP地址、检查并封禁IP
3. 普通聊天 - 其他对话

返回 JSON 格式:
{
  "intent": "add_asset" | "ipblock" | "general_chat",
  "confidence": 0.0-1.0,
  "reasoning": "判断理由"
}"""
```

### 2. IP封禁意图处理（`_handle_ipblock_intent`）

处理流程：
1. 调用 `_extract_ipblock_params` 提取参数
2. 创建 `IpBlockService` 实例
3. 判断操作类型（检查/封禁）
4. 调用相应的API方法
5. 返回适当的结果

### 3. 参数提取（`_extract_ipblock_params`）

提取以下参数：
- `ip_address` - IP地址
- `device_name` - 设备名称（如AF1）
- `device_type` - 设备类型（AF/EDR）
- `action` - 操作类型（check/block/check_and_block）
- `block_type` - 封禁类型（SRC_IP/DST_IP/URL/DNS）
- `time_type` - 时长类型（forever/temporary）
- `time_value` - 时长数值
- `time_unit` - 时间单位（d/h/m）
- `reason` - 封禁原因

### 4. 智能操作流程

```
用户输入
    ↓
LLM意图检测
    ↓
if intent == "ipblock":
    提取参数
    ↓
    if 有device_name:
        调用 check_and_block()
        ↓
        if 已封禁:
            显示状态
        else:
            显示确认对话框
    else:
        调用 check_ip_blocked()
        显示状态
else:
    普通聊天
```

---

## 文件变更

### 修改的文件

1. **backend/app/services/llm_service.py**
   - 修改 `_detect_intent` - 添加"ipblock"意图识别
   - 修改 `chat_with_asset_support` - 添加IP封禁意图处理分支
   - 新增 `_handle_asset_intent` - 处理资产添加意图
   - 新增 `_handle_ipblock_intent` - 处理IP封禁意图
   - 新增 `_extract_ipblock_params` - 提取IP封禁参数

2. **backend/app/api/v1/endpoints/llm.py**
   - 修改 `ChatResponse` 模型 - 添加IP封禁相关字段

---

## 测试建议

### 测试1：简单查询
输入：
```
查询155.158.127.248是否被封禁
```

预期结果：
- 系统识别为IP封禁查询
- 显示该IP的封禁状态

---

### 测试2：检查并封禁
输入：
```
请帮我查询100.200.1.200这个IP地址是否已经被封禁，没有的话帮我调用AF1这个设备进行封禁
```

预期结果：
1. 系统识别为"检查并封禁"操作
2. 查询IP状态
3. 如果未封禁，显示确认对话框：
   - IP: 100.200.1.200
   - 设备: AF1
4. 用户确认后执行封禁
5. 显示封禁结果

---

### 测试3：已封禁的IP
输入：
```
查询100.200.1.200是否被封禁，没有的话帮我调用AF1这个设备进行封禁
```

预期结果（假设IP已封禁）：
- 识别为检查并封禁操作
- 查询后发现IP已封禁
- 直接显示封禁详情（无需确认对话框）

---

### 测试4：直接封禁
输入：
```
使用AF1封禁192.168.1.50
```

预期结果：
- 识别为IP封禁操作
- 显示确认对话框
- 用户确认后执行封禁

---

### 测试5：临时封禁
输入：
```
封禁10.0.0.100，封禁7天，使用设备AF2
```

预期结果：
- 识别为临时封禁操作
- 提取时长参数（7天）
- 显示确认对话框（包含时长信息）
- 执行7天临时封禁

---

## 如何验证

1. **启动后端服务**
   ```bash
   cd /Users/hexing/Flux/backend
   python3 -m uvicorn app.main:app --reload --port 8000
   ```

2. **启动前端服务**
   ```bash
   cd /Users/hexing/Flux/frontend
   npm run dev
   ```

3. **在聊天界面输入**
   ```
   查询155.158.127.248是否被封禁
   ```

4. **观察响应**
   - 应该识别为IP封禁操作
   - 显示IP封禁状态或确认对话框

---

## 故障排查

### 问题1：系统无法识别IP封禁意图

**可能原因**：
- LLM API密钥配置错误
- LLM返回的置信度低于0.7

**解决方案**：
- 检查LLM配置是否正确
- 尝试使用更明确的表述，如"查询IP封禁状态"

---

### 问题2：参数提取失败

**可能原因**：
- 用户输入不够明确
- LLM返回的JSON格式错误

**解决方案**：
- 使用更明确的表述："查询IP地址 192.168.1.1 是否被封禁"
- 提供完整的上下文信息

---

### 问题3：API调用失败

**可能原因**：
- Flux认证信息未配置
- 网络连接问题
- API地址错误

**解决方案**：
- 检查localStorage中的`flux_auth_code`和`flux_base_url`
- 确认后端服务正在运行
- 检查API地址是否正确

---

## 下一步优化

1. **改进意图检测**
   - 添加更多训练示例
   - 调整置信度阈值
   - 支持更多IP封禁场景

2. **增强参数提取**
   - 支持更多自然语言表达
   - 提高参数识别准确率
   - 添加参数验证和纠错

3. **优化用户体验**
   - 添加操作历史记录
   - 支持批量操作
   - 添加操作进度提示

4. **扩展功能**
   - 支持IP解封操作
   - 支持批量IP封禁
   - 添加封禁模板

---

## 总结

现在IP封禁技能已完全集成到聊天系统中，用户可以通过自然语言轻松完成：
- ✅ 查询IP封禁状态
- ✅ 检查并封禁IP
- ✅ 直接封禁IP
- ✅ 临时/永久封禁

系统会自动识别意图、提取参数、调用API、显示结果，无需手动配置或编程！🎉
